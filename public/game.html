<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barnyard Betrayal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* FARM THEME */
        body { margin: 0; background-color: #7bed9f; overflow: hidden; font-family: 'Nunito', sans-serif; touch-action: none; }
        canvas { display: block; background-image: radial-gradient(#7bed9f 20%, #2ed573 20%); background-size: 40px 40px; } /* Grass Pattern */

        /* --- SERVER BROWSER --- */
        #server-browser { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); color: white; display: flex; flex-direction: column; align-items: center; padding-top: 50px; z-index: 200; backdrop-filter: blur(5px); }
        .server-row { background: #fff; color: #333; width: 85%; max-width: 600px; padding: 15px; margin-bottom: 10px; border-radius: 15px; display: flex; align-items: center; justify-content: space-between; border: 4px solid #aaa; }
        .btn-join { background: #2ed573; color: white; border: none; padding: 10px 20px; font-weight: bold; border-radius: 10px; cursor: pointer; border-bottom: 4px solid #26af61; }
        .btn-join:active { transform: translateY(4px); border-bottom: 0; }

        /* --- HUD --- */
        #ui-layer { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .hud-panel { pointer-events: auto; position: absolute; top: 10px; left: 10px; padding: 10px 15px; background: rgba(255,255,255,0.9); border-radius: 12px; border: 3px solid #333; font-weight: bold; color: #333; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        
        /* --- MOBILE CONTROLS --- */
        #mobile-controls { pointer-events: auto; position: absolute; bottom: 20px; left: 20px; display: none; /* Shown by JS on mobile */ }
        .d-pad { position: relative; width: 120px; height: 120px; background: rgba(0,0,0,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); }
        .d-stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.1s; }

        /* --- ACTION BUTTONS --- */
        .action-btn { pointer-events: auto; display: none; position: absolute; bottom: 40px; width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; font-weight: bold; font-size: 16px; text-align: center; line-height: 80px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); color: white; transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.9); }
        #killBtn { background: #ff4757; right: 30px; }
        #reportBtn { background: #ffa502; right: 130px; }

        /* --- MEETING --- */
        #meetingOverlay { display: none; pointer-events: auto; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 52, 54, 0.95); flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 99; }
        .vote-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .player-card { background: #fff; color: #333; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; border: 3px solid #eee; width: 80px; }
    </style>
</head>
<body>

    <div id="server-browser">
        <h1>üöú BARNYARD LIST</h1>
        <div id="server-list" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div style="color:white;">Connecting...</div>
        </div>
    </div>

    <div id="ui-layer">
        <div class="hud-panel">
            <div style="font-size: 1.2rem;">üêÆ <span id="roomName">...</span></div>
            <div style="font-size: 0.9rem; color:#666;">Role: <span id="myRole">...</span></div>
        </div>
        
        <div id="mobile-controls">
            <div class="d-pad" id="joystick-base">
                <div class="d-stick" id="joystick-head"></div>
            </div>
        </div>

        <div id="killBtn" class="action-btn">EAT</div>
        <div id="reportBtn" class="action-btn">ALERT</div>
    </div>

    <div id="meetingOverlay">
        <h1 style="color:#ff4757">üö® EMERGENCY MEETING üö®</h1>
        <p>Who is the Wolf? Vote!</p>
        <div class="vote-grid" id="voteContainer"></div>
    </div>

    <canvas id="gameCanvas"></canvas>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        const SERVER_URL = "https://barnyard-server.onrender.com"; 
        const urlParams = new URLSearchParams(window.location.search);
        const myName = urlParams.get('name') || "Guest";
        const mySkin = urlParams.get('skin') || "bear";

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const socket = io(SERVER_URL);

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const images = {};
        function getImg(type) {
            if(!images[type]) { const i = new Image(); i.src = `assets/${type}.png`; images[type] = i; }
            return images[type];
        }

        let players = {};
        let walls = [];
        let myId = null;
        let isMeeting = false;
        let currentRoomId = null;
        let moveInput = { x: 0, y: 0 }; // For Joystick

        // --- JOYSTICK LOGIC ---
        const joyBase = document.getElementById('joystick-base');
        const joyHead = document.getElementById('joystick-head');
        let dragging = false;

        // Check if mobile to show joystick
        if('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            document.getElementById('mobile-controls').style.display = 'block';
        }

        joyBase.addEventListener('touchstart', (e) => { dragging = true; handleJoy(e.touches[0]); });
        joyBase.addEventListener('touchmove', (e) => { if(dragging) { e.preventDefault(); handleJoy(e.touches[0]); } });
        joyBase.addEventListener('touchend', () => { dragging = false; resetJoy(); });

        function handleJoy(touch) {
            const rect = joyBase.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 35); // Max radius
            const angle = Math.atan2(dy, dx);

            const moveX = Math.cos(angle) * dist;
            const moveY = Math.sin(angle) * dist;

            joyHead.style.transform = `translate(${moveX}px, ${moveY}px)`;
            
            // Normalize input for game loop
            moveInput.x = (Math.abs(dx) > 10) ? Math.sign(dx) : 0;
            moveInput.y = (Math.abs(dy) > 10) ? Math.sign(dy) : 0;
        }

        function resetJoy() {
            joyHead.style.transform = `translate(0px, 0px)`;
            moveInput = {x:0, y:0};
        }

        // --- LOBBY LOGIC ---
        socket.on('roomListUpdate', (rooms) => {
            if(currentRoomId) return;
            const list = document.getElementById('server-list');
            list.innerHTML = '';
            if(rooms.length === 0) list.innerHTML = '<div style="color:white;">No servers online.</div>';
            rooms.forEach(r => {
                const div = document.createElement('div');
                div.className = 'server-row';
                let avatarsHtml = '';
                r.previewSkins.forEach(skin => avatarsHtml += `<img src="assets/${skin}.png" style="width:30px; border-radius:50%; border:2px solid #eee;">`);
                div.innerHTML = `
                    <div>
                        <div style="font-weight:900; font-size:1.1rem;">${r.region}</div>
                        <div style="font-size:0.8rem; color:#777;">${r.playerCount} / ${r.maxPlayers} Farmers</div>
                        <div style="margin-top:5px;">${avatarsHtml}</div>
                    </div>
                    <button class="btn-join" onclick="joinGame('${r.id}')">JOIN</button>
                `;
                list.appendChild(div);
            });
        });

        window.joinGame = (roomId) => {
            currentRoomId = roomId;
            document.getElementById('server-browser').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            document.getElementById('roomName').innerText = roomId.replace('room_', '').toUpperCase();
            socket.emit('joinRoom', { roomId, userData: { name: myName, skin: mySkin } });
            update();
        };

        // --- GAME LOOP ---
        const keys = {};
        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);

        socket.on('currentPlayers', (p) => { players = p; myId = socket.id; updateUI(); });
        socket.on('playerMoved', (p) => { if(players[p.playerId]) Object.assign(players[p.playerId], p); });
        socket.on('mapData', (w) => { walls = w; });
        socket.on('playerDied', (d) => { if(players[d.victimId]) players[d.victimId].isDead = true; });
        socket.on('userDisconnected', (id) => { delete players[id]; });
        socket.on('meetingStarted', () => { isMeeting = true; document.getElementById('meetingOverlay').style.display = 'flex'; renderVoting(); });

        function updateUI() {
            if(players[myId]) {
                const r = players[myId].role;
                const el = document.getElementById('myRole');
                el.innerText = r === 'WOLF' ? 'üê∫ WOLF' : 'üßë‚Äçüåæ FARMER';
                el.style.color = (r === 'WOLF') ? '#ff4757' : '#2ed573';
            }
        }

        function update() {
            if(myId && players[myId] && !isMeeting && !players[myId].isDead) {
                let p = players[myId];
                let mx = 0, my = 0;

                // Keyboard
                if(keys['w']) my=-5; if(keys['s']) my=5;
                if(keys['a']) mx=-5; if(keys['d']) mx=5;
                
                // Joystick Override
                if(moveInput.x !== 0) mx = moveInput.x * 5;
                if(moveInput.y !== 0) my = moveInput.y * 5;

                let nextX = p.x + mx, nextY = p.y + my;
                let collides = walls.some(w => nextX+20>w.x && nextX-20<w.x+w.w && nextY+20>w.y && nextY-20<w.y+w.h);

                if(!collides && (mx||my)) {
                    p.x = nextX; p.y = nextY;
                    socket.emit('playerMovement', { roomId: currentRoomId, x:p.x, y:p.y });
                }
            }
            checkButtons();
            draw();
            requestAnimationFrame(update);
        }

        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            
            // Draw Grass Pattern is handled by CSS, we just clear rect
            
            // Draw Fences (Walls)
            ctx.fillStyle = '#8B4513'; // SaddleBrown
            walls.forEach(w => {
                ctx.fillRect(w.x, w.y, w.w, w.h);
                // Fence Posts detail
                ctx.fillStyle = '#654321';
                ctx.fillRect(w.x, w.y, 5, 5); 
                ctx.fillStyle = '#8B4513';
            });

            // Draw Players
            Object.values(players).forEach(p => {
                const img = getImg(p.skin);
                if(p.isDead) {
                    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(Math.PI/2); 
                    ctx.filter = 'grayscale(100%)'; if(img.complete) ctx.drawImage(img, -20, -20, 40, 40);
                    ctx.restore();
                } else {
                    if(img.complete) ctx.drawImage(img, p.x-25, p.y-25, 50, 50);
                    ctx.fillStyle = "white"; ctx.font = "bold 12px Nunito"; ctx.textAlign = "center"; 
                    ctx.strokeStyle = "black"; ctx.lineWidth = 3;
                    ctx.strokeText(p.name, p.x, p.y - 35);
                    ctx.fillText(p.name, p.x, p.y - 35);
                }
            });
        }

        function checkButtons() {
            if(!myId || !players[myId]) return;
            const me = players[myId];
            const kBtn = document.getElementById('killBtn');
            const rBtn = document.getElementById('reportBtn');
            kBtn.style.display = 'none'; rBtn.style.display = 'none';
            if(me.isDead || isMeeting) return;

            let closest=null, d=9999;
            Object.values(players).forEach(p => {
                if(p.playerId!==myId) {
                    let dist = Math.sqrt((p.x-me.x)**2 + (p.y-me.y)**2);
                    if(dist<d){d=dist; closest=p;}
                }
            });

            if(me.role === 'WOLF' && closest && !closest.isDead && d < 80) {
                kBtn.style.display = 'block';
                kBtn.onclick = () => socket.emit('killPlayer', { roomId: currentRoomId, targetId: closest.playerId });
            }
            const bodyNearby = Object.values(players).some(p => p.isDead && Math.sqrt((p.x-me.x)**2 + (p.y-me.y)**2) < 80);
            if(bodyNearby) {
                rBtn.style.display = 'block';
                rBtn.onclick = () => socket.emit('reportBody', { roomId: currentRoomId });
            }
        }
        
        function renderVoting() {
             const c = document.getElementById('voteContainer'); c.innerHTML = '';
            Object.values(players).forEach(p => {
                const card = document.createElement('div');
                card.className = `player-card ${p.isDead ? 'dead' : ''}`;
                card.innerHTML = `<img src="assets/${p.skin}.png" style="width:100%"><br>${p.name}`;
                card.onclick = () => socket.emit('castVote', p.playerId); // Add voting logic
                c.appendChild(card);
            });
        }
    </script>
</body>
</html>
